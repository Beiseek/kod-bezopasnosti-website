#!/bin/bash

# ==============================================================================
#  –°–£–ü–ï–†-–ú–ï–ì–ê-–§–ò–ö–° –°–¢–ê–¢–ò–ß–ï–°–ö–ò–• –§–ê–ô–õ–û–í
#  –ö–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ
# ==============================================================================

echo "üöÄ –°–£–ü–ï–†-–ú–ï–ì–ê-–§–ò–ö–° –°–¢–ê–¢–ò–ß–ï–°–ö–ò–• –§–ê–ô–õ–û–í..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –í–°–ï —Å–ª—É–∂–±—ã
echo "--- [–®–ê–ì 1/8] –û–°–¢–ê–ù–û–í–ö–ê –í–°–ï–• –°–õ–£–ñ–ë ---"
supervisorctl stop kodbezopasnosti 2>/dev/null || true
systemctl stop nginx 2>/dev/null || true

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/kod-bezopasnosti

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source venv/bin/activate

echo "--- [–®–ê–ì 2/8] –ü–ï–†–ï–°–û–ó–î–ê–ù–ò–ï –ü–ê–ü–û–ö –î–õ–Ø –°–¢–ê–¢–ò–ö–ò ---"
rm -rf staticfiles
mkdir staticfiles
rm -rf static
git checkout -- static

echo "--- [–®–ê–ì 3/8] –°–û–ë–ò–†–ê–ï–ú –°–¢–ê–¢–ò–ö–£ –ê–î–ú–ò–ù–ö–ò ---"
python manage.py collectstatic --noinput --clear

echo "--- [–®–ê–ì 4/8] –ö–û–ü–ò–†–£–ï–ú –°–¢–ê–¢–ò–ö–£ –°–ê–ô–¢–ê –ù–ê–ü–†–Ø–ú–£–Æ ---"
# –ö–æ–ø–∏—Ä—É–µ–º CSS, JS –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∞–ø–∫—É, –∫–æ—Ç–æ—Ä—É—é –≤–∏–¥–∏—Ç Nginx
cp -r static/* staticfiles/

echo "--- [–®–ê–ì 5/8] –ü–†–û–í–ï–†–ö–ê –°–ö–û–ü–ò–†–û–í–ê–ù–ù–´–• –§–ê–ô–õ–û–í ---"
echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ staticfiles:"
ls -lR staticfiles/

echo "--- [–®–ê–ì 6/8] –ò–°–ü–†–ê–í–õ–Ø–ï–ú –ü–†–ê–í–ê –î–û–°–¢–£–ü–ê ---"
chown -R www-data:www-data /var/www/kod-bezopasnosti
chmod -R 755 /var/www/kod-bezopasnosti

echo "--- [–®–ê–ì 7/8] –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê–ï–ú GUNICORN ---"
supervisorctl reread
supervisorctl update
supervisorctl start kodbezopasnosti

echo "--- [–®–ê–ì 8/8] –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê–ï–ú NGINX ---"
systemctl start nginx

echo ""
echo "========================================================"
echo "‚úÖ –°–£–ü–ï–†-–ú–ï–ì–ê-–§–ò–ö–° –ó–ê–í–ï–†–®–ï–ù!"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å —Å–∞–π—Ç:"
echo "  üåê http://91.229.8.148/"
echo "  üåê http://91.229.8.148/admin/"
echo ""
echo "–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:"
echo "  tail -f /var/log/kodbezopasnosti.err.log"
echo "  tail -f /var/log/nginx/kod-bezopasnosti.error.log"
echo "========================================================"
